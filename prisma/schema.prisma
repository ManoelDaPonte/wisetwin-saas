// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  firstName     String?
  name          String?
  email         String    @unique
  password      String
  image         String?
  azureContainerId String? @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  emailVerified DateTime?
  organizations Organization[]
  OrganizationMember OrganizationMember[]
  sentInvitations OrganizationInvitation[] @relation("InvitedBy")

  // Relations pour le système de formations
  memberTags    MemberTag[]
  assignedTags  MemberTag[] @relation("TagAssignedBy")
  buildTags     BuildTag[]
  trainingAnalytics   TrainingAnalytics[]
  passwordResets      PasswordReset[]
}

model Organization {
  id              String    @id @default(cuid())
  name            String
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  azureContainerId String   @unique
  owner           User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId         String
  members         OrganizationMember[]
  invitations     OrganizationInvitation[]
  
  // Relations pour le système de formations
  trainingTags    TrainingTag[]
  trainingAnalytics TrainingAnalytics[]
}

model OrganizationMember {
  id             String       @id @default(cuid())
  role           Role         @default(MEMBER)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId])
}

model OrganizationInvitation {
  id              String       @id @default(cuid())
  email           String
  role            Role         @default(MEMBER)
  token           String       @unique @default(cuid())
  code            String       @unique // Code court pour saisie manuelle (8 caractères)
  
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  invitedById     String
  invitedBy       User         @relation("InvitedBy", fields: [invitedById], references: [id])
  
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime     // 7 jours par défaut
  acceptedAt      DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@unique([email, organizationId]) // Une seule invitation active par email/org
  @@index([token])
  @@index([code])
  @@index([email])
}

enum Role {
  ADMIN
  MEMBER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum BuildType {
  WISETOUR
  WISETRAINER
}

enum Priority {
  LOW
  MEDIUM  
  HIGH
}

// === SYSTÈME DE GESTION DE FORMATIONS ===

// Tags pour catégoriser les collaborateurs - représente un plan de formation complet
model TrainingTag {
  id             String @id @default(cuid())
  name           String
  color          String? // Code couleur hex pour l'interface
  description    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  archived       Boolean @default(false)
  
  // Configuration du plan de formation
  dueDate        DateTime? // Date limite pour ce plan de formation
  priority       Priority @default(MEDIUM) // Priorité du plan complet
  
  // Relations
  memberTags     MemberTag[]
  buildTags      BuildTag[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([name, organizationId]) // Noms uniques par organisation
  @@index([organizationId])
  @@index([dueDate])
  @@index([archived])
}

// Relations membre-tag (many-to-many)
model MemberTag {
  id           String @id @default(cuid())
  userId       String
  tagId        String
  assignedById String // Qui a assigné ce tag
  
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tag        TrainingTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  assignedBy User        @relation("TagAssignedBy", fields: [assignedById], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([userId, tagId]) // Un utilisateur ne peut avoir le même tag qu'une fois
  @@index([userId])
  @@index([tagId])
}

// Assignment des builds Unity aux tags - association simple
model BuildTag {
  id          String @id @default(cuid())
  tagId       String
  buildName   String  // Nom du build Unity (ex: "Formation Sécurité v1.2")
  buildType   BuildType // WISETOUR ou WISETRAINER
  containerId String  // Container Azure où se trouve le build
  
  // Métadonnées
  assignedById String
  
  // Relations
  tag         TrainingTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  assignedBy  User @relation(fields: [assignedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([tagId, buildName, buildType, containerId])
  @@index([tagId])
  @@index([containerId, buildType])
  @@index([buildName, buildType])
}

// Suivi des formations avec notifications

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

// === SYSTÈME D'ANALYTICS DE FORMATION ===

model TrainingAnalytics {
  id                String   @id @default(cuid())
  sessionId         String   @unique
  trainingId        String
  userId            String
  organizationId    String?
  buildName         String
  buildType         BuildType
  buildVersion      String?   @default("1.0.0") // Version du build pour filtrage et rétrocompatibilité
  containerId       String

  // Données temporelles
  startTime         DateTime
  endTime           DateTime
  totalDuration     Float    // en secondes
  completionStatus  CompletionStatus

  // Métriques globales
  score                 Float    @default(0) // Score final Unity (0-100)
  totalInteractions      Int
  successfulInteractions Int
  failedInteractions    Int

  // JSON pour stocker les interactions détaillées
  interactions      Json     // Array<InteractionRecord>

  // Relations
  user             User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  certificateVerification CertificateVerification?

  @@index([userId])
  @@index([organizationId])
  @@index([buildName])
  @@index([buildVersion])
  @@index([sessionId])
  @@index([completionStatus])
  @@index([startTime])
}

enum CompletionStatus {
  COMPLETED
  ABANDONED
  IN_PROGRESS
  FAILED
}

model CertificateVerification {
  id                  String             @id @default(cuid())
  code                String             @unique
  formationName       String?            // Nom de la formation affiché sur le certificat
  trainingAnalyticsId String             @unique
  trainingAnalytics   TrainingAnalytics  @relation(fields: [trainingAnalyticsId], references: [id], onDelete: Cascade)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@index([code])
}
